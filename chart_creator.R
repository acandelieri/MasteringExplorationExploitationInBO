rm(list=ls()); graphics.off(); cat("\014")

library(DiceDesign)
source("test_problems.R")

root = "results_100runs"


fs = list.files(root)

runs = 30


par(mfrow=c(1,3))


resTable = data.frame( tf=character(),
                       appr=character(),
                       augc=numeric(),
                       l2disc=numeric(),
                       stringsAsFactors=F )

FINAL.BOXES = list()

for( f in fs ) {
  
  cat("\014> Test Problem:",f,"\n")
  fls = list.files(paste0(root,"/",f))
  
  clrs = c("red2","green2","green3","orange","blue","skyblue","darkgrey","purple","violet")

  
  
  gaps.mu = gaps.sd = NULL
  approaches = NULL
  boxes = list()
  disc = list()
  
  ALL.GAPS = ALL.DISC = list()
    
  for( fl in fls ) {
      
    res = readRDS(paste0(root,"/",f,"/",fl))
    
    approaches = c(approaches,unlist(strsplit(fl,"_",T))[1])
    # renaming 2 functions for visualization
    approaches = gsub("-Alternating"," (altern.)",approaches,fixed=T)
    approaches = gsub("-Switching"," (switch.)",approaches,fixed=T)  
    
    gaps = dc = NULL
    for( r in 1:max(res$run) ) {
      df = res[which(res$run==r),]
      ixs = which(df$af.info=="init")
      ybs = cummin(c( min(df$y[ixs]), df$y[-ixs] ))
      fname = unlist(strsplit(f,".",fixed=T))[1]
      if( fname=="stybtang") {
        ystar = actualOptimum(fname,2)
      } else {
        ystar = actualOptimum(fname)
      }
      
      gaps = rbind(gaps,(ybs[1]-ybs)/(ybs[1]-ystar))
      dc = c(dc,unlist(discrepancyCriteria(df[,c(3:(ncol(df)-3))],"L2")))
      
    }
    
    boxes = c(boxes,list(gaps[,ncol(gaps)]))
    disc = c(disc,list(dc))
    
    ALL.GAPS = c(ALL.GAPS,list(apply(gaps,1,sum)))
    ALL.DISC = c(ALL.DISC,list(dc))
    
    
    gaps.mu = rbind( gaps.mu, apply(gaps,2,mean))
    gaps.sd = rbind( gaps.sd, apply(gaps,2,sd))
  
  }
  
  FINAL.BOXES[[length(FINAL.BOXES)+1]] = boxes
  
  gaps.up = gaps.mu+gaps.sd
  gaps.dw = gaps.mu-gaps.sd
  gaps.dw[which(gaps.dw<0)] = 0
  gaps.up[which(gaps.up>1)] = 1
  
  
  
  plot( length(ixs):(ncol(gaps.mu)+length(ixs)-1), gaps.mu[1,], type="l", ylim=0:1,
        main=NA, xlab="BO iterations", ylab="Average GAP metric",
        cex.axis=1.5, cex.lab=1.5 ) 
  # for( i in 1:nrow(gaps.mu) ) 
  #   polygon( c(1:ncol(gaps.mu),ncol(gaps.mu):1),
  #            c(gaps.dw[i,],rev(gaps.up[i,])),
  #            col=adjustcolor(clrs[i],alpha.f=0.2) )
  for( i in 1:nrow(gaps.mu) ) {
    lines( length(ixs):(ncol(gaps.mu)+length(ixs)-1), gaps.mu[i,], lwd=3, col=clrs[i] )
    # lines( gaps.up[i,], lwd=2, lty=2, col=clrs[i] )
    # lines( gaps.dw[i,], lwd=2, lty=2, col=clrs[i] )
  }
  
  if( f %in% c("camel3.3d","goldpr.2d","stybtang.2d","hartmann6.6d") ) {
    legend("topleft",legend=approaches[1:4],col=clrs[1:4],lwd=3,cex=1.5,bty="n")
    legend("bottomright",legend=approaches[5:length(approaches)],col=clrs[5:length(approaches)],lwd=3,cex=1.5,bty="n")
  } else {
    if( f=="schwefel.2d" ) {
      legend("topleft",legend=approaches[1:5],col=clrs[1:6],lwd=3,cex=1.5,bty="n")
      legend("bottomright",legend=approaches[-c(1:6)],col=clrs[-c(1:6)],lwd=3,cex=1.5,bty="n")  
    } else {
      if( f!="camel6.6d") {
        legend("bottomright",legend=approaches,col=clrs,lwd=3,cex=1.5,bty="n")  
      }
    }
  }
  
  
  gaps.pts = apply(gaps.mu,1,sum)/ncol(gaps.mu)

  disc.pts = matrix( unlist(disc),ncol=length(disc[[1]]), byrow=T )
  
  disc.pts = apply(disc.pts,1,mean)
  
  boxplot( disc, col=clrs, main=f, cex.main=1.5,
           ylab="L2-discrepancy (at the end of BO)",
           cex.lab=1.5, xaxt="n")
  if( f=="camel6.6d" )  {
    legend("topleft",legend=approaches[1:4],col=clrs[1:4],lwd=3,cex=1.5, bty="n")  
    legend("topright",legend=approaches[-c(1:4)],col=clrs[-c(1:4)],lwd=3,cex=1.5, bty="n")  
  }
  
  
  p.ixs = NULL
  for( i in 1:length(gaps.pts) ) {
    # Pareto Front
    ii = which( gaps.pts[-i] > gaps.pts[i] & disc.pts[-i] < disc.pts[i] )
    i1 = which( gaps.pts[-i] < gaps.pts[i] )
    i2 = which( disc.pts[-i] > disc.pts[i] )
    if( length(ii) == 0 & (length(i1)>0 | length(i2)>0) )
      p.ixs = c(p.ixs,i)

  }

  plot( gaps.pts, disc.pts, pch=19, cex=1.5, col=clrs,
        xlim=0:1, main="", cex.axis=1.5, cex.lab=1.5,
        ylab="Average L2-discrepancy (at the end of BO)",
        xlab="Area under the average GAP curve")
  p.ixs = p.ixs[order(gaps.pts[p.ixs])]
  points(gaps.pts[p.ixs], disc.pts[p.ixs], cex=2.5, lwd=2 )
  lines( c(-1,gaps.pts[p.ixs],max(gaps.pts[p.ixs])),
         c(min(disc.pts[p.ixs]),disc.pts[p.ixs],2*max(disc.pts)),
         type="S" )
  
  
  
  for( i in 1:length(gaps.pts) ) {
    resTable = rbind( resTable, data.frame( tf=f,
                                            appr=approaches[i],
                                            augc=round(gaps.pts[i],4),
                                            l2d=round(disc.pts[i],4) ) )
  }
  
}

par(mfrow=c(1,1))

invisible(readline("Modify the size of the Plots window for the final boxplot, then press [RETURN]"))

par(mfrow=c(1,1))
curr.mar = par("mar")
par(mar=c(11.1,4.1,4.1,4.1))
for( i in 1:length(FINAL.BOXES) ) 
  boxplot( FINAL.BOXES[[i]], col=clrs, names=approaches, las=2,
           cax.lab=1.5, cex.axis=1.5,
           main=paste(fs[i],"- average GAP at the end of BO") )
par(mar=curr.mar)

print( resTable )



