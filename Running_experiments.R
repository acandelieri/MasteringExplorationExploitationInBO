rm(list=ls()); graphics.off(); cat("\014")

source("core.R")
source("test_problems.R")

ps = c("beale.2d","braninmodif.2d","camel3.3d","camel6.6d",
       "hartmann3.3d","hartmann4.4d","hartmann6.6d","goldpr.2d",
       "rosenbrock.2d","schwefel.2d","stybtang.2d")

dgt = 8
n.runs = 30
set.seed(42)
seeds = sample(1:(10*n.runs),n.runs,replace=F)

beta0 = 1
delta_1 = 0.1 # in Srinivas_1!
delta_2 = 0.01 # in Srinivas_2!
theta = NA; #TODO: controllare valore suggerito in Randomised GP-CB
epsilon = 0.1 # in Greed-is-good

  
L = 1/10
# nu = max(5,5*(d-1))

cat("> Select the approach:\n\n")
cat("[1] Srinivas's GP-CB (Theorem 1)\n")
cat("[2] Srinivas's GP-CB (Theorem 2 + 'empirical workaround')\n")
cat("[3] epsilon-greedy with RS\n")
cat("[4] epsilon-greedy with random-Pareto\n")
cat("[5] Randomised GP-CB\n")
cat("[6] The Master GP-CB\n")
cat("[7] GP-CB (constant beta)\n")
cat("[8] PI is Back! - alternating\n")
cat("[9] PI is Back! - switching (75%)\n")
cat("[10] CB/UR - alternating\n")
cat("[11] CB/UR - switching (75%)\n\n")

approach = 0
while( !(approach %in% 1:10) )
  suppressWarnings( expr=(approach = as.integer(readline("> Make you choice: "))) )

approaches.name = c("Srinivas_1","Srinivas_2","epsRS","epsPareto","RandCB","masterCB","CB",
                    "PIisBackAlternating","PIisBack-Switching",
                    "CB-UR-Alternating","CB-UR-Switching")



for( p in ps ) {
  
  
  cat("\014[ Test problem:",p,"]\n")
  cat("*** Approach:",approaches.name[approach],"***\n")
  
  # retrieving test problem's info
  f.name = unlist(strsplit(p,".",fixed=T))
  d = as.integer(gsub(pattern="d",replacement="",x=f.name[2],fixed=T ))
  f.name = f.name[1]

  
  N = 20*d
  n0 = 5*d
  
  nu = max(5,5*(d-1))
  
  
  df = data.frame( run=rep(NA,n.runs*N),
                   iter=rep(NA,n.runs*N),
                   x=matrix(NA,n.runs*N,d),
                   y=rep(NA,n.runs*N),
                   af.info=rep(NA,n.runs*N),
                   af.note=rep(NA,n.runs*N) )
  
  jj = 0
  
  for( run in 1:n.runs ) {
    
    cat("\n> Run #",run,sep="")
    
    
    #*************************************************************
    #* Init design
    #*************************************************************
    
    cat("\n> Design initialization via LHS...")
    set.seed(seeds[run])
    X = round(maximinLHS(n=n0,k=d),dgt)
    y = round(apply(X,1,f.name),dgt)
    cat("Done!\n")
  
    af.info = rep("init",n0)
    af.note = rep(NA,n0)
  
    df$run[N*(run-1)+jj+(1:n0)] = rep(run,n0)
    df$iter[N*(run-1)+jj+(1:n0)] = 1:n0
    df[N*(run-1)+jj+(1:n0),2+(1:d)] = X
    df$y[N*(run-1)+jj+(1:n0)] = y
    df$af.info[N*(run-1)+jj+(1:n0)] = af.info
    df$af.note[N*(run-1)+jj+(1:n0)] = af.note
  
    jj = n0
  
    #*************************************************************
    #* Sequential optimization
    #*************************************************************
    

    if( approach == 6 ) { N1=5*d } else { N1=0 }
       
    
    cat("> Sequential optimization")
    
    while( jj<(N-N1) ) {
      cat(".")
      
      # fit the probabilistic surrogate model
      gp = km(design=df[N*(run-1)+(1:jj),2+(1:d)],
              response=df$y[N*(run-1)+(1:jj)],
              covtype="gauss",nugget.estim=T,control=list(trace=0) )
      
    
      # acquisition function
      res = switch( approach,
                    "1" = next.Srinivas_1(gp,dgt,delta_1),
                    "2" = next.Srinivas_2(gp,dgt,delta_2),
                    "3" = next.epsRS(gp,epsilon),
                    "4" = next.epsPareto(gp,epsilon),
                    "5" = next.randCB(gp,bea.mu,beta.sd),
                    "6" = next.masterCB(gp,L,nu),
                    "7" = next.CB(gp,beta0),
                    "8" = next.PIisBack.alternating(gp,dgt=dgt),
                    "9" = next.PIisBack.switching(gp,N,rate=0.75),
                    "10" = next.CB_UR.alternating(gp),
                    "11" = next.CB_UR.switching(gp,N,rate=0.75) )
      
      x_= round(res$par,dgt)
      y_ = round(do.call(args=list(x=x_),f.name),dgt)
      
      df$run[N*(run-1)+jj+1] = run
      df$iter[N*(run-1)+jj+1] = nrow(gp@X)+1
      df[N*(run-1)+jj+1,2+(1:d)] = x_
      df$y[N*(run-1)+jj+1] = y_
      df$af.info[N*(run-1)+jj+1] = res$af.info
      df$af.note[N*(run-1)+jj+1] = res$af.note
      
      jj = jj+1
      
    }
    cat("Done!\n")
    
    
    
    #*************************************************************
    #* Final refining - only for Candy-CB
    #*************************************************************
    
    while( jj<N ) {
      #TODO
    }
    
    
    
    
    
    cat("> Collecting results...")
    
    
    cat("Done!\n")
    
    jj=0
    
  }
  
  #*************************************************************
  #* Saving results
  #*************************************************************
  
  cat("> Saving results...")
  
  if( !dir.exists( paste0("results/",p) ) ) 
    dir.create( paste0("results/",p),recursive=T )
  
  saveRDS(df,paste0("results/",p,"/",approaches.name[approach],"_",p,".RDS")) 
  
  gc()
  
  cat("Done!\n")
    
}
