rm(list=ls()); graphics.off(); cat("\014")

source("core.R")
source("test_problems.R")

ps = c("braninsc.2d","camel3.3d","camel6.6d",
       "hartmann3.3d","hartmann4.4d","hartmann6.6d","goldpr.2d",
       "rosenbrock.2d","schwefel.2d","stybtang.2d")


dgt = 8
n.runs = 100
set.seed(42)
seeds = sample(1:(10*n.runs),n.runs,replace=F)

beta0 = 1
delta_1 = 0.1 # in Srinivas_1!
delta_2 = 0.01 # in Srinivas_2!
theta = 0.5; # most promising value according to results in "Randomised Gaussian Process Confidence Bound"
epsilon = 0.1 # in Greed-is-good

  
L = 1/10

# nu = floor((15*d)/3)    # or nu = max(5,5*(d-1))?

cat("> Select the approach:\n\n")
cat("[1] Srinivas's GP-CB (Theorem 1)\n")
cat("[2] Srinivas's GP-CB (Theorem 2 + 'empirical workaround')\n")
cat("[3] epsilon-greedy with RS\n")
cat("[4] epsilon-greedy with random-Pareto\n")
cat("[5] Randomised GP-CB\n")
cat("[6] The Master mu-UR\n")
cat("[7] GP-CB (constant beta)\n")
cat("[8] PI is Back! - alternating\n")
cat("[9] PI is Back! - switching (75%)\n")


approach = 0
while( !(approach %in% 1:9) )
  suppressWarnings( expr=(approach = as.integer(readline("> Make you choice: "))) )

approaches.name = c("Srinivas Th.1","Srinivas Th.2","epsRS","epsPF","Randomised CB","mastering",
                    "CB","PIisBack-Alternating","PIisBack-Switching" )



for( p in ps ) {
  
  
  cat("\014[ Test problem:",p,"]\n")
  cat("*** Approach:",approaches.name[approach],"***\n")
  
  # retrieving test problem's info
  f.name = unlist(strsplit(p,".",fixed=T))
  d = as.integer(gsub(pattern="d",replacement="",x=f.name[2],fixed=T ))
  f.name = f.name[1]

  
  N = 20*d
  n0 = 5*d
  
  # nu = max(5,5*(d-1))
  nu = floor((15*d)/3)
  
  df = data.frame( run=rep(NA,n.runs*N),
                   iter=rep(NA,n.runs*N),
                   x=matrix(NA,n.runs*N,d),
                   y=rep(NA,n.runs*N),
                   af.info=rep(NA,n.runs*N),
                   af.note=rep(NA,n.runs*N) )
  
  jj = 0
  
  for( run in 1:n.runs ) {
    
    cat("\n> Run #",run,sep="")
    
    
    #*************************************************************
    #* Init design
    #*************************************************************
    
    cat("\n> Design initialization via LHS...")
    set.seed(seeds[run])
    X = round(maximinLHS(n=n0,k=d),dgt)
    y = round(apply(X,1,f.name),dgt)
    cat("Done!\n")
  
    af.info = rep("init",n0)
    af.note = rep(NA,n0)
  
    df$run[N*(run-1)+jj+(1:n0)] = rep(run,n0)
    df$iter[N*(run-1)+jj+(1:n0)] = 1:n0
    df[N*(run-1)+jj+(1:n0),2+(1:d)] = X
    df$y[N*(run-1)+jj+(1:n0)] = y
    df$af.info[N*(run-1)+jj+(1:n0)] = af.info
    df$af.note[N*(run-1)+jj+(1:n0)] = af.note
  
    jj = n0
  
    #*************************************************************
    #* Sequential optimization
    #*************************************************************
    

    if( approach == 6 ) { N1=5*d } else { N1=0 }
       
    
    cat("> Sequential optimization")
    
    while( jj<(N-N1) ) {
      cat(".")
      
      # fit the probabilistic surrogate model
      gp = NULL
      try( expr = ( gp = km(design=df[N*(run-1)+(1:jj),2+(1:d)],
                            response=df$y[N*(run-1)+(1:jj)],
                            covtype="gauss",nugget.estim=F,control=list(trace=0) )) ,
                    silent = T ) 
      if( is.null(gp) ) {
        cat("*")
        gp = km(design=df[N*(run-1)+(1:jj),2+(1:d)],
                response=df$y[N*(run-1)+(1:jj)],
                covtype="gauss",nugget.estim=T,control=list(trace=0) )
      }
      
    
      # acquisition function
      res = switch( approach,
                    "1" = next.Srinivas_1(gp=gp,dgt=dgt,delta=delta_1,lbfgsb=T),
                    "2" = next.Srinivas_2(gp=gp,dgt=dgt,delta=delta_2,lbfgsb=T),
                    "3" = next.epsRS(gp=gp,epsilon=epsilon,lbfgsb=T),
                    "4" = next.epsPareto(gp=gp,epsilon=epsilon,lbfgsb=T),
                    "5" = next.randCB(gp,theta,dgt,use.lbfgsb=T),
                    "6" = next.masterAF(gp=gp,L=L,nu=nu,beta=0,dgt=dgt,lbfgsb=T),
                    "7" = next.CB(gp=gp,beta=beta0,dgt=dgt,lbfgsb=T),
                    "8" = next.PIisBack.alternating(gp=gp,dgt=dgt,lbfgsb=T),
                    "9" = next.PIisBack.switching(gp=gp,N=N,rate=0.75,dgt=dgt,lbfgsb=T) )
      
      x_= round(res$par,dgt)
      y_ = round(do.call(args=list(x=x_),f.name),dgt)
      
      df$run[N*(run-1)+jj+1] = run
      df$iter[N*(run-1)+jj+1] = nrow(gp@X)+1
      df[N*(run-1)+jj+1,2+(1:d)] = x_
      df$y[N*(run-1)+jj+1] = y_
      df$af.info[N*(run-1)+jj+1] = res$af.info
      df$af.note[N*(run-1)+jj+1] = res$af.note
      
      jj = jj+1
      
    }
    cat("Done!\n")
    
    
    
    #*************************************************************
    #* Final refining - only for Mastering
    #*************************************************************
     
    if( jj < N )
      cat("> Final refyining")
    
    while( jj<N ) {
      
      cat(".")
      
      # fit the probabilistic surrogate model
      gp = NULL
      try( expr=(gp = km(design=df[N*(run-1)+(1:jj),2+(1:d)],
                         response=df$y[N*(run-1)+(1:jj)],
                         covtype="gauss",nugget.estim=F,control=list(trace=0) )),
           silent = T )
      if( is.null(gp) ) {
        cat("*")
        gp = km(design=df[N*(run-1)+(1:jj),2+(1:d)],
                response=df$y[N*(run-1)+(1:jj)],
                covtype="gauss",nugget.estim=T,control=list(trace=0) )
      }
      
      
      # 'mastering' acquisition function
      res = next.CB(gp=gp,beta=0,dgt=dgt,lbfgsb=T)
    
      x_= round(res$par,dgt)
      y_ = round(do.call(args=list(x=x_),f.name),dgt)
      
      df$run[N*(run-1)+jj+1] = run
      df$iter[N*(run-1)+jj+1] = nrow(gp@X)+1
      df[N*(run-1)+jj+1,2+(1:d)] = x_
      df$y[N*(run-1)+jj+1] = y_
      df$af.info[N*(run-1)+jj+1] = res$af.info
      df$af.note[N*(run-1)+jj+1] = res$af.note
      
      jj = jj+1
      
    }
    cat("Done!\n")
    
    
    
    cat("> Collecting results...")
    
    
    cat("Done!\n")
    
    jj=0
    
  }
  
  #*************************************************************
  #* Saving results
  #*************************************************************
  
  cat("> Saving results...")
  
  
  if( !dir.exists( paste0("results_",n.runs,"runs/",p) ) ) 
    dir.create( paste0("results_",n.runs,"runs/",p),recursive=T )
  saveRDS(df,paste0("results_",n.runs,"runs/",p,"/",approaches.name[approach],"_",p,".RDS")) 
  
  
  gc()
  
  cat("Done!\n")
    
}
